FROM ubuntu:22.04

# Metadatos
LABEL maintainer="Crypto Nexus Team <security@cryptonexus.local>"
LABEL version="1.0-vulnerable"
LABEL description="Crypto Nexus Ultra - Web Application with Intentional Vulnerabilities"

# Instalar dependencias con vulnerabilidades
RUN apt-get update && apt-get install -y \
    apache2 \
    php8.1 \
    php8.1-mysql \
    php8.1-curl \
    php8.1-gd \
    php8.1-mbstring \
    php8.1-xml \
    php8.1-zip \
    php8.1-ldap \
    libapache2-mod-php8.1 \
    openssh-server \
    mysql-client \
    curl \
    wget \
    vim \
    net-tools \
    iputils-ping \
    netcat \
    python3 \
    python3-pip \
    nodejs \
    npm \
    git \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Configurar Apache con vulnerabilidades
RUN a2enmod rewrite headers proxy proxy_http ssl
COPY config/apache2.conf /etc/apache2/apache2.conf
COPY config/000-default.conf /etc/apache2/sites-available/000-default.conf

# Configurar PHP con configuraciones inseguras
COPY config/php.ini /etc/php/8.1/apache2/php.ini
RUN echo "display_errors = On" >> /etc/php/8.1/apache2/php.ini && \
    echo "error_reporting = E_ALL" >> /etc/php/8.1/apache2/php.ini && \
    echo "allow_url_fopen = On" >> /etc/php/8.1/apache2/php.ini && \
    echo "allow_url_include = On" >> /etc/php/8.1/apache2/php.ini

# Configurar SSH con credenciales débiles
RUN mkdir /var/run/sshd && \
    echo 'root:toor' | chpasswd && \
    echo 'admin:admin123' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Crear usuarios vulnerables
RUN useradd -m -s /bin/bash crypto_user && \
    echo 'crypto_user:Crypto123!' | chpasswd && \
    usermod -aG sudo crypto_user && \
    echo 'crypto_user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# Copiar aplicación web vulnerable
COPY src/ /var/www/html/
RUN chown -R www-data:www-data /var/www/html && \
    chmod -R 777 /var/www/html/uploads && \
    chmod 777 /var/www/html/config.php && \
    chmod 777 /var/www/html/includes/db.php

# Crear directorios vulnerables
RUN mkdir -p /backups && \
    chmod 777 /backups && \
    mkdir -p /opt/scripts && \
    chmod 777 /opt/scripts

# Copiar scripts vulnerables
COPY vulnerable_scripts/ /opt/scripts/
RUN chmod +x /opt/scripts/*.sh

# Crear archivos sensibles
RUN echo "AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE" > /root/.aws_credentials && \
    echo "AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" >> /root/.aws_credentials && \
    chmod 644 /root/.aws_credentials

RUN echo "DATABASE_PASSWORD=SuperSecretDBPassword123!" > /var/www/html/.env && \
    echo "JWT_SECRET=very_weak_jwt_secret_2025" >> /var/www/html/.env

# Crear archivo de flags para CTF
RUN echo "FLAG{W3lc0m3_t0_Crypt0_N3xus}" > /root/flag.txt && \
    echo "FLAG{SSH_Access_Granted}" > /home/crypto_user/flag.txt && \
    echo "FLAG{Database_Credentials_Exposed}" > /var/www/html/flag_db.txt

# Exponer puertos
EXPOSE 80 22 443

# Script de inicio con servicios vulnerables
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Health check (vulnerable a command injection)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

CMD ["/entrypoint.sh"]
